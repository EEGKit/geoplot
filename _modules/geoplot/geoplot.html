

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>geoplot.geoplot &mdash; geoplot 0.4.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-dataframe.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> geoplot
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/quickstart.html">Quickstart</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/Working_with_Geospatial_Data.html">Working with Geospatial Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/Working_with_Projections.html">Working with Projections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide/Customizing_Plots.html">Customizing Plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot_references/plot_reference.html">Plot Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Gallery</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gallery/index.html">Gallery</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">geoplot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>geoplot.geoplot</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for geoplot.geoplot</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines the majority of geoplot functions, including all plot types.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">cartopy.feature</span> <span class="kn">import</span> <span class="n">ShapelyFeature</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">geoplot.crs</span> <span class="k">as</span> <span class="nn">gcrs</span>
<span class="kn">from</span> <span class="nn">cartopy.mpl.geoaxes</span> <span class="kn">import</span> <span class="n">GeoAxesSubplot</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">descartes</span>
<span class="kn">import</span> <span class="nn">contextily</span> <span class="k">as</span> <span class="nn">ctx</span>
<span class="kn">import</span> <span class="nn">mapclassify</span> <span class="k">as</span> <span class="nn">mc</span>

<span class="kn">from</span> <span class="nn">.ops</span> <span class="kn">import</span> <span class="n">QuadTree</span><span class="p">,</span> <span class="n">build_voronoi_polygons</span><span class="p">,</span> <span class="n">jitter_points</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">geopandas.plotting</span> <span class="kn">import</span> <span class="n">_mapclassify_choro</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">geopandas.plotting</span> <span class="kn">import</span> <span class="n">__pysal_choro</span> <span class="k">as</span> <span class="n">_mapclassify_choro</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.4.1&quot;</span>
<span class="n">MATPLOTLIB_DOCS_VERSION</span> <span class="o">=</span> <span class="s2">&quot;3.2.1&quot;</span>  <span class="c1"># used in some docstrings</span>


<span class="k">class</span> <span class="nc">HueMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class container for hue-setter code shared across all plots that support hue.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">set_hue_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">color_kwarg</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">default_color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span>
        <span class="n">supports_categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verify_input</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;hue&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The &#39;k&#39; parameter was removed in geoplot version 0.4.0. To set a specific &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;categorical bin count, pass a mapclassify object to &#39;scheme&#39; instead. For &quot;</span>
                <span class="sa">f</span><span class="s1">&#39;further information refer to the release notes at &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;https://github.com/ResidentMario/geoplot/releases/tag/0.4.0&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">supports_categorical</span><span class="p">:</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scheme&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># kdeplot is special: it has a &#39;cmap&#39; parameter but no &#39;hue&#39; or &#39;scheme&#39; parameters,</span>
        <span class="c1"># merely passing those parameters to `seaborn.kdeplot`. So for these plots we don&#39;t</span>
        <span class="c1"># validate.</span>
        <span class="k">if</span> <span class="n">verify_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">color_kwarg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="ow">and</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Cannot specify both &quot;</span><span class="si">{</span><span class="n">color_kwarg</span><span class="si">}</span><span class="s1">&quot; and &quot;hue&quot; in the same plot.&#39;</span>
                <span class="p">)</span>
            <span class="c1"># in theory we should also vet k, but since None is a meaningful value for this</span>
            <span class="c1"># variable it&#39;s not possible to know definitively if k was set as a default or by the</span>
            <span class="c1"># user.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">scheme</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Cannot specify &quot;cmap&quot; or &quot;scheme&quot; without specifying &quot;hue&quot;.&#39;</span>
                <span class="p">)</span>

        <span class="n">hue</span> <span class="o">=</span> <span class="n">_to_geoseries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">hue</span><span class="p">,</span> <span class="s2">&quot;hue&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># no colormap</span>
            <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">color_kwarg</span><span class="p">,</span> <span class="n">default_color</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">color</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="p">((</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;categorical&#39;</span><span class="p">)</span> <span class="ow">or</span>
              <span class="p">(</span><span class="n">scheme</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hue</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">))):</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">hue</span><span class="p">)</span>
            <span class="n">value_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">categories</span><span class="p">)}</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">value_map</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">hue</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_map</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scheme</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">hue</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">hue</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hue</span><span class="p">]</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># scheme is not None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">scheme</span> <span class="o">==</span> <span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                    
                    <span class="n">scheme</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">scheme</span><span class="p">)(</span><span class="n">hue</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">opts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">CLASSIFIERS</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Categorical&#39;</span><span class="p">])</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Invalid scheme </span><span class="si">{</span><span class="n">scheme</span><span class="si">!r}</span><span class="s1">. If specified as a string, scheme must be one &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;of </span><span class="si">{</span><span class="n">opts</span><span class="si">}</span><span class="s1">.&#39;</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scheme</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">scheme</span><span class="o">.</span><span class="n">yb</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">scheme</span><span class="o">.</span><span class="n">yb</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">scheme</span><span class="p">(</span><span class="n">hue</span><span class="p">)</span>
            <span class="n">binedges</span> <span class="o">=</span> <span class="p">[</span><span class="n">scheme</span><span class="o">.</span><span class="n">yb</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span> <span class="o">+</span> <span class="n">scheme</span><span class="o">.</span><span class="n">bins</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;</span><span class="si">{0:g}</span><span class="s1"> - </span><span class="si">{1:g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">binedges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">binedges</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">binedges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scheme</span><span class="o">.</span><span class="n">bins</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hue</span> <span class="o">=</span> <span class="n">hue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="n">categories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color_kwarg</span> <span class="o">=</span> <span class="n">color_kwarg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_color</span> <span class="o">=</span> <span class="n">default_color</span>


<span class="k">class</span> <span class="nc">ScaleMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class container for scale-setter code shared across all plots that support scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">set_scale_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size_kwarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_size</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;limits&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scale_func&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">_to_geoseries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dslope</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">dmax</span> <span class="o">-</span> <span class="n">dmin</span><span class="p">)</span>
                <span class="c1"># edge case: if dmax, dmin are &lt;=10**-30 or so, will overflow and eval to infinity</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">dslope</span><span class="p">):</span> 
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;The data range provided to the &#39;scale&#39; variable is too small for the &quot;</span>
                        <span class="s2">&quot;default scaling function. Normalize your data or provide a custom &quot;</span>
                        <span class="s2">&quot;&#39;scale_func&#39;.&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dscale</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">dval</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dslope</span> <span class="o">*</span> <span class="p">(</span><span class="n">dval</span> <span class="o">-</span> <span class="n">dmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_func</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">)</span>

            <span class="c1"># Apply the scale function.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dscale</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">])</span>

            <span class="c1"># When a scale is applied, large observations will tend to obfuscate small ones.</span>
            <span class="c1"># Plotting in descending size order, so that smaller values end up on top, helps</span>
            <span class="c1"># clean the plot up a bit.</span>
            <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">)[</span><span class="n">sorted_indices</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;colors&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">)[</span><span class="n">sorted_indices</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Theoretically we should validate limits as well, but since the default limits value</span>
            <span class="c1"># is not None this can&#39;t be done completely reliably.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Cannot specify &quot;scale_func&quot; without specifying &quot;scale&quot;.&#39;</span>
                <span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">size_kwarg</span><span class="p">,</span> <span class="n">default_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LegendMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class container for legend-builder code shared across all plots that support legend.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">paint_legend</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">supports_hue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">supports_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verify_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">legend_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;legend_labels&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">legend_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;legend_values&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">legend_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;legend_kwargs&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">legend_marker_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">legend_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">legend_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">legend_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># as a power user feature, certain marker* parameters can be passed along to the</span>
                <span class="c1"># Line2D markers in the patch legend</span>
                <span class="k">if</span> <span class="n">kwarg</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;marker&#39;</span><span class="p">:</span>
                    <span class="n">legend_marker_kwargs</span><span class="p">[</span><span class="n">kwarg</span><span class="p">]</span> <span class="o">=</span> <span class="n">legend_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">kwarg</span><span class="p">)</span>

        <span class="c1"># kdeplot is special: it has a &#39;legend&#39; parameter but no other legend-related params,</span>
        <span class="c1"># as the &#39;legend&#39; param is merely passed down to `seaborn.kdeplot`. So for kdeplot</span>
        <span class="c1"># we do not verify inputs.</span>
        <span class="k">if</span> <span class="n">verify_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">legend</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="n">supports_hue</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="ow">not</span> <span class="n">supports_scale</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;&quot;legend&quot; is set to True, but the plot has neither a &quot;hue&quot; nor a &quot;scale&quot; &#39;</span>
                    <span class="s1">&#39;variable.&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">legend</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">legend_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">legend_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span>
                <span class="n">legend_kwargs</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot specify &quot;legend_labels&quot;, &quot;legend_values&quot;, or &quot;legend_kwargs&quot; &#39;</span>
                    <span class="s1">&#39;when &quot;legend&quot; is set to False.&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">legend_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">legend_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_values</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;The &quot;legend_labels&quot; and &quot;legend_values&quot; parameters have different lengths.&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">legend</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="s1">&#39;legend_var&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;legend_var&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot specify &quot;legend_labels&quot;, &quot;legend_values&quot;, or &quot;legend_kwargs&quot; &#39;</span>
                    <span class="s1">&#39;when &quot;legend&quot; is set to False.&#39;</span>
                <span class="p">)</span>

        <span class="c1"># Mutate matplotlib defaults</span>
        <span class="n">addtl_legend_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">addtl_legend_kwargs</span><span class="p">[</span><span class="s1">&#39;fancybox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">legend_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fancybox&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">supports_hue</span> <span class="ow">and</span> <span class="n">supports_scale</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;legend_var&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">legend_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;legend_var&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">legend_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;hue&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;legend_var&quot;, if specified, must be set to one of &quot;hue&quot; or &quot;scale&quot;.&#39;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">legend_var</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;legend_var&quot; is set to &quot;</span><span class="si">{</span><span class="n">legend_var</span><span class="si">!r}</span><span class="s1">&quot;, but &quot;</span><span class="si">{</span><span class="n">legend_var</span><span class="si">!r}</span><span class="s1">&quot; is &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;unspecified.&#39;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">legend</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Please specify &quot;legend_var&quot; explicitly when both &quot;hue&quot; and &quot;scale&quot; are &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;specified. Defaulting to &quot;legend_var=</span><span class="se">\&#39;</span><span class="s1">hue</span><span class="se">\&#39;</span><span class="s1">&quot;.&#39;</span>
                    <span class="p">)</span>
                <span class="n">legend_var</span> <span class="o">=</span> <span class="s1">&#39;hue&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;scale&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;legend_var&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">legend_var</span> <span class="o">=</span> <span class="s1">&#39;hue&#39;</span>

        <span class="k">if</span> <span class="n">legend</span> <span class="ow">and</span> <span class="n">legend_var</span> <span class="o">==</span> <span class="s1">&#39;hue&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If the user provides a markeredgecolor in legend_kwargs, use that. Otherwise,</span>
                <span class="c1"># if they provide an edgecolor in kwargs, reuse that. Otherwise, default to a</span>
                <span class="c1"># transparent markeredgecolor.</span>
                <span class="k">if</span> <span class="s1">&#39;markeredgecolor&#39;</span> <span class="ow">in</span> <span class="n">legend_marker_kwargs</span><span class="p">:</span>
                    <span class="n">markeredgecolor</span> <span class="o">=</span> <span class="n">legend_marker_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;markeredgecolor&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;edgecolor&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">markeredgecolor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">markeredgecolor</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>

                <span class="c1"># If the user provides a markerfacecolor in legend_kwargs, but the legend is in</span>
                <span class="c1"># hue mode, raise an error, as setting this markerfacecolor would invalidate the</span>
                <span class="c1"># utility of the legend.</span>
                <span class="k">if</span> <span class="s1">&#39;markerfacecolor&#39;</span> <span class="ow">in</span> <span class="n">legend_marker_kwargs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Cannot set a &quot;markerfacecolor&quot; when the &quot;legend_var&quot; is set to &quot;hue&quot;. &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Doing so would remove the color reference, rendering the legend &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;useless. Are you sure you didn</span><span class="se">\&#39;</span><span class="s1">t mean to set &quot;markeredgecolor&quot; instead?&#39;</span>
                    <span class="p">)</span>

                <span class="n">marker_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s1">&#39;markersize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;markeredgecolor&#39;</span><span class="p">:</span> <span class="n">markeredgecolor</span>
                <span class="p">}</span>
                <span class="n">marker_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">legend_marker_kwargs</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">legend_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">markerfacecolors</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span>
                                        <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">markerfacecolors</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">legend_values</span><span class="p">]</span>

                <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">markerfacecolor</span> <span class="ow">in</span> <span class="n">markerfacecolors</span><span class="p">:</span>
                    <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">mpl</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                            <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">markerfacecolor</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">marker_kwargs</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">legend_labels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">patches</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;The list of legend values is length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">patches</span><span class="p">)</span><span class="si">}</span><span class="s1">, but the list of &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;legend_labels is length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">legend_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                        <span class="n">patches</span><span class="p">,</span> <span class="n">legend_labels</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">legend_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">addtl_legend_kwargs</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;The plot is in categorical legend mode, implying a &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;matplotlib.legend.Legend&quot; legend object. However, &quot;legend_kwarg&quot; &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;contains unexpected keyword arguments not supported by this legend type.&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39; Are you sure you are not accidentally passing continuous &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;matplotlib.colorbar.Colorbar&quot; legend parameters instead?&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;For a &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;reference on the valid keyword parameters, see the matplotlib &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;documentation at &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;https://matplotlib.org/</span><span class="si">{</span><span class="n">MATPLOTLIB_DOCS_VERSION</span><span class="si">}</span><span class="s1">/api/legend_api.html#&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;matplotlib.legend.Legend . To learn more about the difference &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;between these two legend modes, refer to the geoplot documentation &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;at https://residentmario.github.io/geoplot/user_guide/&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Customizing_Plots.html#legend .&#39;</span>
                    <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># self.k is None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_marker_kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;k&quot; is set to &quot;None&quot;, implying a colorbar legend, but &quot;legend_kwargs&quot; &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;includes marker parameters that can only be applied to a patch legend. &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Remove these parameters or convert to a categorical colormap by &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;specifying a &quot;k&quot; value.&#39;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">legend_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">legend_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># TODO: implement this feature</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;k&quot; is set to &quot;None&quot;, implying a colorbar legend, but &quot;legend_labels&quot; &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;and/or &quot;legend_values&quot; are also specified. These parameters do not &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;apply in the case of a colorbar legend and should be removed.&#39;</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hue</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">legend_kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;The plot is in continuous legend mode, implying a &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;matplotlib.colorbar.Colorbar&quot; legend object. However, &quot;legend_kwarg&quot; &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;contains unexpected keyword arguments not supported by this legend type.&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39; Are you sure you are not accidentally passing categorical &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;matplotlib.legend.Legend&quot; legend parameters instead?&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;For a &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;reference on the valid keyword parameters, see the matplotlib &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;documentation at &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;https://matplotlib.org/</span><span class="si">{</span><span class="n">MATPLOTLIB_DOCS_VERSION</span><span class="si">}</span><span class="s1">/api/colorbar_api.html#&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;matplotlib.colorbar.Colorbar . To learn more about the difference &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;between these two legend modes, refer to the geoplot documentation &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;at https://residentmario.github.io/geoplot/user_guide/&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Customizing_Plots.html#legend .&#39;</span>
                    <span class="p">)</span>

        <span class="k">elif</span> <span class="n">legend</span> <span class="ow">and</span> <span class="n">legend_var</span> <span class="o">==</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">legend_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If the user doesn&#39;t specify their own legend_values, apply a reasonable</span>
                <span class="c1"># default: a five-point linear array from max to min. The sort order (max to min,</span>
                <span class="c1"># not min to max) is important because ax.legend, the matplotlib function these</span>
                <span class="c1"># values are ultimately passed to, sorts the patches in ascending value order</span>
                <span class="c1"># internally. Even though we pass no patch ordering information to ax.legend,</span>
                <span class="c1"># it still appears to determine an ordering by inspecting plot artists</span>
                <span class="c1"># automagically. In the case where there is no colormap, however, the patch order</span>
                <span class="c1"># we pass is preserved.</span>
                <span class="c1">#</span>
                <span class="c1"># The TLDR is that it&#39;s possible to control scale legend patch order (and make it</span>
                <span class="c1"># ascending or descending) in a non-hue plot, in all other cases legend patch order</span>
                <span class="c1"># is locked to ascending, so for consistency across the API we use ascending order</span>
                <span class="c1"># in this case as well.</span>
                <span class="n">legend_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">dtype</span>
                <span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">legend_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If the user doesn&#39;t specify their own legend_labels, apply a reasonable</span>
                <span class="c1"># default: the &#39;g&#39; f-string for the given input value.</span>
                <span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0:g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">legend_values</span><span class="p">]</span>

            <span class="c1"># If the user specifies a markerfacecolor explicity via legend_params, use that.</span>
            <span class="c1">#</span>
            <span class="c1"># Otherwise, use an open-circle design when hue is not None, so as not to confuse</span>
            <span class="c1"># viewers with colors in the scale mapping to values that do not correspond with the</span>
            <span class="c1"># plot points. But if there is no hue, it&#39;s better to have the legend markers be as</span>
            <span class="c1"># close to the plot markers as possible, so in that case the points are filled-in with</span>
            <span class="c1"># the corresponding plot color value. This is controlled by self.colors and, in the</span>
            <span class="c1"># case where hue is None, will be an n-length list of the same color value or name, so</span>
            <span class="c1"># we can grab that by taking the first element of self.colors.</span>
            <span class="k">if</span> <span class="s1">&#39;markerfacecolor&#39;</span> <span class="ow">in</span> <span class="n">legend_marker_kwargs</span><span class="p">:</span>
                <span class="n">markerfacecolors</span> <span class="o">=</span> <span class="p">[</span><span class="n">legend_marker_kwargs</span><span class="p">[</span><span class="s1">&#39;markerfacecolor&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_values</span><span class="p">)</span>
                <span class="n">legend_marker_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;markerfacecolor&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">markerfacecolors</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">markerfacecolors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_values</span><span class="p">)</span>

            <span class="n">markersizes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dscale</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_multiplier</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">legend_values</span><span class="p">]</span>

            <span class="c1"># If the user provides a markeredgecolor in legend_kwargs, use that. Otherwise, default</span>
            <span class="c1"># to a steelblue or black markeredgecolor, depending on whether hue is defined.</span>
            <span class="k">if</span> <span class="s1">&#39;markeredgecolor&#39;</span> <span class="ow">in</span> <span class="n">legend_marker_kwargs</span><span class="p">:</span>
                <span class="n">markeredgecolor</span> <span class="o">=</span> <span class="n">legend_marker_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;markeredgecolor&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">markeredgecolor</span> <span class="o">=</span> <span class="s1">&#39;steelblue&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">markeredgecolor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>

            <span class="c1"># If the user provides a markersize in legend_kwargs, but the legend is in</span>
            <span class="c1"># scale mode, raise an error, as setting this markersize would invalidate the</span>
            <span class="c1"># utility of the legend.</span>
            <span class="k">if</span> <span class="s1">&#39;markersize&#39;</span> <span class="ow">in</span> <span class="n">legend_marker_kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Cannot set a &quot;markersize&quot; when the &quot;legend_var&quot; is set to &quot;scale&quot;. &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;Doing so would remove the scale reference, rendering the legend &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;useless.&#39;</span>
                <span class="p">)</span>

            <span class="n">marker_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s1">&#39;markeredgecolor&#39;</span><span class="p">:</span> <span class="n">markeredgecolor</span>
            <span class="p">}</span>
            <span class="n">marker_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">legend_marker_kwargs</span><span class="p">)</span>

            <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">markerfacecolor</span><span class="p">,</span> <span class="n">markersize</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">markerfacecolors</span><span class="p">,</span> <span class="n">markersizes</span>
            <span class="p">):</span>
                <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">mpl</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                        <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
                        <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">markerfacecolor</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">marker_kwargs</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">patches</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;The list of legend values is length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">patches</span><span class="p">)</span><span class="si">}</span><span class="s1">, but the list of &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;legend_labels is length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                <span class="n">patches</span><span class="p">,</span> <span class="n">legend_labels</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">legend_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">addtl_legend_kwargs</span>
            <span class="p">)</span>


<span class="k">class</span> <span class="nc">ClipMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class container for clip-setter code shared across all plots that support clip.</span>

<span class="sd">    Note that there are two different routines for clipping a plot:</span>
<span class="sd">    * Drawing an inverted polyplot as the top layer. Implemented in `paint_clip`. Advantage is</span>
<span class="sd">      that it is fast, disadvantage is that the resulting plot can&#39;t be applied to a webmap.</span>
<span class="sd">    * Intersecting each geometry with the unary union of the clip geometries. This is a slower</span>
<span class="sd">      but more broadly compatible process. It&#39;s also quite fast if the clip geometry used is</span>
<span class="sd">      relatively simple, but this requires conscious effort the user (we can&#39;t simplify</span>
<span class="sd">      automatically unfortunately).</span>

<span class="sd">    KDEPlot uses the first method because it relies on `seaborn` underneath, and there is no way</span>
<span class="sd">    to clip an existing axis painter (that I am aware of). All other plots use the second method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">set_clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gdf</span><span class="p">):</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">_to_geom_geoseries</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="s2">&quot;clip&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clip_shp</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">unary_union</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">geometry</span><span class="o">=</span><span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">clip_shp</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">null_geoms</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
            <span class="c1"># Clipping may result in null geometries. We warn about this here, but it is = the</span>
            <span class="c1"># responsibility of the plot draw procedure to perform the actual plot exclusion.</span>
            <span class="k">if</span> <span class="n">null_geoms</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;The input data contains </span><span class="si">{</span><span class="n">null_geoms</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s1"> data points that do not &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;intersect with &quot;clip&quot;. These data points will not appear in the plot.&#39;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">gdf</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_clip</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">clip</span><span class="p">):</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">extent</span>
        <span class="c1"># We have to add a little bit of padding to the edges of the box, as otherwise the edges</span>
        <span class="c1"># will invert a little, surprisingly.</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">),</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">),</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">affinity</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">xfact</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">yfact</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">clip</span><span class="p">:</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rect</span>

    <span class="k">def</span> <span class="nf">paint_clip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">_to_geom_geoseries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="s2">&quot;clip&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_extent</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
                <span class="n">clip_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_clip</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>
                <span class="n">feature</span> <span class="o">=</span> <span class="n">ShapelyFeature</span><span class="p">([</span><span class="n">clip_geom</span><span class="p">],</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
                <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
                <span class="n">clip_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_clip</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
                <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
                <span class="n">polyplot</span><span class="p">(</span>
                    <span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">clip_geom</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span>
                <span class="p">)</span>


<span class="k">class</span> <span class="nc">QuadtreeComputeMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class container for computing a quadtree.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">compute_quadtree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nmin&#39;</span><span class="p">)</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nmax&#39;</span><span class="p">)</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hue&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="n">_to_geoseries</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hue</span><span class="p">,</span> <span class="s2">&quot;hue&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: what happens in the case of a column name collision?</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">hue_col</span><span class="o">=</span><span class="n">hue</span><span class="p">)</span>

        <span class="c1"># set reasonable defaults for the n-params</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">nmax</span> <span class="k">if</span> <span class="n">nmax</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">nmin</span> <span class="o">=</span> <span class="n">nmin</span> <span class="k">if</span> <span class="n">nmin</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Jitter the points. Otherwise if there are n points sharing the same coordinate, but</span>
        <span class="c1"># n_sig &lt; n, the quadtree algorithm will recurse infinitely. Jitter is applied randomly</span>
        <span class="c1"># on 10**-5 scale, inducing maximum additive inaccuracy of ~1cm - good enough for the</span>
        <span class="c1"># vast majority of geospatial applications. If the meaningful precision of your dataset</span>
        <span class="c1"># exceeds 1cm, jitter the points yourself. cf. https://xkcd.com/2170/</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">jitter_points</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">))</span>

        <span class="c1"># Generate a quadtree.</span>
        <span class="n">quad</span> <span class="o">=</span> <span class="n">QuadTree</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">partitions</span> <span class="o">=</span> <span class="n">quad</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">nmin</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partitions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">partitions</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">QuadtreeHueMixin</span><span class="p">(</span><span class="n">HueMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subclass of HueMixin that provides modified hue-setting code for the quadtree plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">set_hue_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color_kwarg</span><span class="p">,</span> <span class="n">default_color</span><span class="p">):</span>
        <span class="n">agg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>
        <span class="n">nsig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nsig&#39;</span><span class="p">)</span>
        <span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">dvals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># If no hue is set, getting the correct (null) colormap values is as easy as calling</span>
        <span class="c1"># the same set_hue_values used by most other plots.</span>
        <span class="c1">#</span>
        <span class="c1"># If hue *is* set, things are more complicated. The quadtree colormap is applied to a map</span>
        <span class="c1"># over self.partitions, but set_hue_values is called on self.df. So we temporarily swap</span>
        <span class="c1"># self.df out for the map on self.partitions, run set_hue_values, then swap the original</span>
        <span class="c1"># GeoDataFrame back into place. We apply the nsig adjustment afterwards.</span>
        <span class="n">has_hue</span> <span class="o">=</span> <span class="s1">&#39;hue&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;hue&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">has_hue</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partitions</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># empty</span>
                    <span class="n">dval</span> <span class="o">=</span> <span class="n">agg</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">has_hue</span><span class="p">:</span>
                    <span class="n">dval</span> <span class="o">=</span> <span class="n">agg</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hue_col</span><span class="p">)</span>
                <span class="n">dvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dval</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;hue&#39;</span><span class="p">]:</span> <span class="n">dvals</span>
            <span class="p">})</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_hue_values</span><span class="p">(</span><span class="n">color_kwarg</span><span class="o">=</span><span class="s1">&#39;facecolor&#39;</span><span class="p">,</span> <span class="n">default_color</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">_df</span>

            <span class="c1"># apply the special nsig parameter colormap rule</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dvals</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dval</span> <span class="o">&lt;</span> <span class="n">nsig</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_hue_values</span><span class="p">(</span><span class="n">color_kwarg</span><span class="o">=</span><span class="s1">&#39;facecolor&#39;</span><span class="p">,</span> <span class="n">default_color</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Plot</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">):</span>
            <span class="c1"># The two valid df types are GeoDataFrame and GeoSeries. The former may be missing</span>
            <span class="c1"># a geometry column, depending on how it was initialzied. The latter always returns</span>
            <span class="c1"># self when it is asked for its geometry property, and so it will never be the source</span>
            <span class="c1"># of this error.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The input GeoDataFrame does not have a &quot;geometry&quot; column set.&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># a default figsize is always set and passed into the initializer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;figsize&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>  <span class="c1"># non-default user setting</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;Cannot set &quot;figsize&quot; when passing an &quot;ax&quot; to the plot. To remove this &#39;</span>
                    <span class="s1">&#39;warning omit the &quot;figsize&quot; parameter.&#39;</span>
                <span class="p">)</span>
                <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">figsize</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">())</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;figsize&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ax&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;extent&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;projection&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: init_axis() -&gt; init_axis(ax)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_axis</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">init_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">extrema</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># default matplotlib plot extent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">total_bounds</span>
            <span class="c1"># Plots suffer clipping issues if we use just the geometry extrema due to plot features</span>
            <span class="c1"># that fall outside of the viewport. The most common case is the edges of polygon</span>
            <span class="c1"># patches with non-zero linewidth. We partially ameliorate the problem by increasing</span>
            <span class="c1"># the viewport by 1% of the total coordinate area of the plot. Note that the</span>
            <span class="c1"># coordinate area covered will differ from the actual area covered, as distance between</span>
            <span class="c1"># degrees varies depending on where you are on the globe. Since the effect is small we</span>
            <span class="c1"># ignore this problem here, for simplicity&#39;s sake.</span>
            <span class="n">extrema</span> <span class="o">=</span> <span class="n">relax_bounds</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>

        <span class="n">extent</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">central_longitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">extent</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span> <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>\
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">extrema</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
        <span class="n">central_latitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">extent</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span> <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>\
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">extrema</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;central_longitude&#39;</span><span class="p">:</span> <span class="n">central_longitude</span><span class="p">,</span>
                <span class="s1">&#39;central_latitude&#39;</span><span class="p">:</span> <span class="n">central_latitude</span>
            <span class="p">})</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">GeoAxesSubplot</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">projection</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">extent</span> <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">extrema</span>

            <span class="k">if</span> <span class="n">xmin</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span> <span class="ow">or</span> <span class="n">xmax</span> <span class="o">&gt;</span> <span class="mi">180</span> <span class="ow">or</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span> <span class="ow">or</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;geoplot expects input geometries to be in latitude-longitude coordinates, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;but the values provided include points whose values exceed the maximum &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;or minimum possible longitude or latitude values (-180, -90, 180, 90), &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;indicating that the input data is not in proper latitude-longitude format.&#39;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">((</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># This occurs either due to numerical stability errors in cartopy or due</span>
                    <span class="c1"># to the extent exceeding the projection parameters. The latter *ought* to</span>
                    <span class="c1"># only happen when using the Orthographic projection (maybe others?), which</span>
                    <span class="c1"># is on a globe and only shows at most half of the world at a time. So if the</span>
                    <span class="c1"># plot extent exceeds the world half in any dimension the extent-setting</span>
                    <span class="c1"># operation will fail.</span>
                    <span class="c1">#</span>
                    <span class="c1"># The default behavior in cartopy is to use a global extent with</span>
                    <span class="c1"># central_latitude and central_longitude as its center. This is the behavior</span>
                    <span class="c1"># we will follow in failure cases.</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Orthographic</span><span class="p">):</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s1">&#39;Plot extent lies outside of the Orthographic projection</span><span class="se">\&#39;</span><span class="s1">s &#39;</span>
                            <span class="s1">&#39;viewport. Defaulting to global extent.&#39;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s1">&#39;Cound not set plot extent successfully due to numerical instability. &#39;</span>
                            <span class="s1">&#39;Try setting extent manually. Defaulting to a global extent.&#39;</span>
                        <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Cartopy 0.18+</span>
                    <span class="n">outline</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">outline</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">outline_patch</span>
                <span class="n">outline</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axison</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span>


<span class="k">def</span> <span class="nf">pointplot</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">scale_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legend_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A geospatial scatter plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : GeoDataFrame</span>
<span class="sd">        The data being plotted.</span>
<span class="sd">    projection : geoplot.crs object instance, optional</span>
<span class="sd">        The projection to use. For reference see</span>
<span class="sd">        `Working with Projections</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Working_with_Projections.html&gt;`_.</span>
<span class="sd">    hue : None, Series, GeoSeries, iterable, or str, optional</span>
<span class="sd">        The column in the dataset (or an iterable of some other data) used to color the points.</span>
<span class="sd">        For a reference on this and the other hue-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Hue</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#hue&gt;`_.</span>
<span class="sd">    cmap : matplotlib color, optional</span>
<span class="sd">        If ``hue`` is specified, the</span>
<span class="sd">        `colormap &lt;http://matplotlib.org/examples/color/colormaps_reference.html&gt;`_ to use.</span>
<span class="sd">    norm: function, optional</span>
<span class="sd">        A `colormap normalization function &lt;https://matplotlib.org/users/colormapnorms.html&gt;`_</span>
<span class="sd">        which will be applied to the data before plotting.</span>
<span class="sd">    scheme : None or mapclassify object, optional</span>
<span class="sd">        If ``hue`` is specified, the categorical binning scheme to use.</span>
<span class="sd">    scale : str or iterable, optional</span>
<span class="sd">        The column in the dataset (or an iterable of some other data) with which to scale output</span>
<span class="sd">        points. For a reference on this and the other scale-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Scale </span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#scale&gt;`_.</span>
<span class="sd">    limits : (min, max) tuple, optional</span>
<span class="sd">        If ``scale`` is set, the minimum and maximum size of the points.</span>
<span class="sd">    scale_func : ufunc, optional</span>
<span class="sd">        If ``scale`` is set, the function used to determine the size of each point. For reference</span>
<span class="sd">        see the</span>
<span class="sd">        `Pointplot Scale Functions</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/gallery/plot_usa_city_elevations.html#sphx-glr-gallery-plot-usa-city-elevations-py&gt;`_</span>
<span class="sd">        demo.</span>
<span class="sd">    legend : boolean, optional</span>
<span class="sd">        Whether or not to include a map legend. For a reference on this and the other </span>
<span class="sd">        legend-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Legend</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#legend&gt;`_.</span>
<span class="sd">    legend_values : list, optional</span>
<span class="sd">        The data values to be used in the legend.</span>
<span class="sd">    legend_labels : list, optional</span>
<span class="sd">        The data labels to be used in the legend.</span>
<span class="sd">    legend_var : &quot;hue&quot; or &quot;scale&quot;, optional</span>
<span class="sd">        Which variable, ``hue`` or ``scale``, to use in the legend.</span>
<span class="sd">    legend_kwargs : dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying legend.</span>
<span class="sd">    extent : None or (min_longitude, min_latitude, max_longitude, max_latitude), optional</span>
<span class="sd">        Controls the plot extents. For reference see </span>
<span class="sd">        `Customizing Plots#Extent</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#extent&gt;`_.</span>
<span class="sd">    figsize : (x, y) tuple, optional</span>
<span class="sd">        Sets the size of the plot figure (in inches).</span>
<span class="sd">    ax : AxesSubplot or GeoAxesSubplot instance, optional</span>
<span class="sd">        If set, the ``matplotlib.axes.AxesSubplot`` or ``cartopy.mpl.geoaxes.GeoAxesSubplot``</span>
<span class="sd">        instance to paint the plot on. Defaults to a new axis.</span>
<span class="sd">    kwargs: dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying `matplotlib.pyplot.scatter instance</span>
<span class="sd">        &lt;http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.scatter&gt;`_.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``AxesSubplot`` or ``GeoAxesSubplot``</span>
<span class="sd">        The plot axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">PointPlot</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span> <span class="n">HueMixin</span><span class="p">,</span> <span class="n">ScaleMixin</span><span class="p">,</span> <span class="n">LegendMixin</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_hue_values</span><span class="p">(</span><span class="n">color_kwarg</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">default_color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_scale_values</span><span class="p">(</span><span class="n">size_kwarg</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">default_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paint_legend</span><span class="p">(</span><span class="n">supports_hue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">supports_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">ax</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ax</span>

            <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plot</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">])</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plot</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">c</span><span class="o">=</span><span class="n">plot</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span>
                    <span class="c1"># the ax.scatter &#39;s&#39; param is an area but the API is unified on width in pixels</span>
                    <span class="c1"># (or &quot;points&quot;), so we have to square the value at draw time to get the correct</span>
                    <span class="c1"># point size.</span>
                    <span class="n">s</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">plot</span><span class="o">.</span><span class="n">sizes</span><span class="p">],</span>
                    <span class="o">**</span><span class="n">plot</span><span class="o">.</span><span class="n">kwargs</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">plot</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">plot</span><span class="o">.</span><span class="n">sizes</span><span class="p">],</span> <span class="o">**</span><span class="n">plot</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="n">PointPlot</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">scale_func</span><span class="o">=</span><span class="n">scale_func</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">legend_var</span><span class="o">=</span><span class="n">legend_var</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="n">legend_values</span><span class="p">,</span>
        <span class="n">legend_labels</span><span class="o">=</span><span class="n">legend_labels</span><span class="p">,</span> <span class="n">legend_kwargs</span><span class="o">=</span><span class="n">legend_kwargs</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">polyplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A trivial polygonal plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : GeoDataFrame</span>
<span class="sd">        The data being plotted.</span>
<span class="sd">    projection : geoplot.crs object instance, optional</span>
<span class="sd">        The projection to use. For reference see</span>
<span class="sd">        `Working with Projections</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Working_with_Projections.html&gt;`_.</span>
<span class="sd">    extent : None or (min_longitude, min_latitude, max_longitude, max_latitude), optional</span>
<span class="sd">        Controls the plot extents. For reference see </span>
<span class="sd">        `Customizing Plots#Extent</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#extent&gt;`_.</span>
<span class="sd">    figsize : (x, y) tuple, optional</span>
<span class="sd">        Sets the size of the plot figure (in inches).</span>
<span class="sd">    ax : AxesSubplot or GeoAxesSubplot instance, optional</span>
<span class="sd">        If set, the ``matplotlib.axes.AxesSubplot`` or ``cartopy.mpl.geoaxes.GeoAxesSubplot``</span>
<span class="sd">        instance to paint the plot on. Defaults to a new axis.</span>
<span class="sd">    kwargs: dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying matplotlib `Polygon patches</span>
<span class="sd">        &lt;http://matplotlib.org/api/patches_api.html#matplotlib.patches.Polygon&gt;`_.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``AxesSubplot`` or ``GeoAxesSubplot``</span>
<span class="sd">        The plot axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">PolyPlot</span><span class="p">(</span><span class="n">Plot</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ax</span>

            <span class="n">edgecolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">facecolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;facecolor&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
            <span class="n">zorder</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;zorder&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                    <span class="n">features</span> <span class="o">=</span> <span class="n">ShapelyFeature</span><span class="p">([</span><span class="n">geom</span><span class="p">],</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span>
                        <span class="n">features</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>  <span class="c1"># Duck test for MultiPolygon.</span>
                        <span class="k">for</span> <span class="n">subgeom</span> <span class="ow">in</span> <span class="n">geom</span><span class="p">:</span>
                            <span class="n">feature</span> <span class="o">=</span> <span class="n">descartes</span><span class="o">.</span><span class="n">PolygonPatch</span><span class="p">(</span>
                                <span class="n">subgeom</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span>
                            <span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>  <span class="c1"># Shapely Polygon.</span>
                        <span class="n">feature</span> <span class="o">=</span> <span class="n">descartes</span><span class="o">.</span><span class="n">PolygonPatch</span><span class="p">(</span>
                            <span class="n">geom</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span>
                        <span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ax</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="n">PolyPlot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">choropleth</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legend_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A color-mapped area plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    df : GeoDataFrame</span>
<span class="sd">        The data being plotted.</span>
<span class="sd">    projection : geoplot.crs object instance, optional</span>
<span class="sd">        The projection to use. For reference see</span>
<span class="sd">        `Working with Projections</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Working_with_Projections.html&gt;`_.</span>
<span class="sd">    hue : None, Series, GeoSeries, iterable, or str, optional</span>
<span class="sd">        The column in the dataset (or an iterable of some other data) used to color the points.</span>
<span class="sd">        For a reference on this and the other hue-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Hue</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#hue&gt;`_.</span>
<span class="sd">    cmap : matplotlib color, optional</span>
<span class="sd">        The</span>
<span class="sd">        `colormap &lt;http://matplotlib.org/examples/color/colormaps_reference.html&gt;`_ to use.</span>
<span class="sd">    norm: function, optional</span>
<span class="sd">        A `colormap normalization function &lt;https://matplotlib.org/users/colormapnorms.html&gt;`_</span>
<span class="sd">        which will be applied to the data before plotting.</span>
<span class="sd">    scheme : None or mapclassify object, optional</span>
<span class="sd">        The categorical binning scheme to use.</span>
<span class="sd">    legend : boolean, optional</span>
<span class="sd">        Whether or not to include a map legend. For a reference on this and the other </span>
<span class="sd">        legend-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Legend</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#legend&gt;`_.</span>
<span class="sd">    legend_values : list, optional</span>
<span class="sd">        The data values to be used in the legend.</span>
<span class="sd">    legend_labels : list, optional</span>
<span class="sd">        The data labels to be used in the legend.</span>
<span class="sd">    legend_kwargs : dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying legend.</span>
<span class="sd">    extent : None or (min_longitude, min_latitude, max_longitude, max_latitude), optional</span>
<span class="sd">        Controls the plot extents. For reference see </span>
<span class="sd">        `Customizing Plots#Extent</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#extent&gt;`_.</span>
<span class="sd">    figsize : (x, y) tuple, optional</span>
<span class="sd">        Sets the size of the plot figure (in inches).</span>
<span class="sd">    ax : AxesSubplot or GeoAxesSubplot instance, optional</span>
<span class="sd">        If set, the ``matplotlib.axes.AxesSubplot`` or ``cartopy.mpl.geoaxes.GeoAxesSubplot``</span>
<span class="sd">        instance to paint the plot on. Defaults to a new axis.</span>
<span class="sd">    kwargs: dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying ``matplotlib`` `Polygon patches</span>
<span class="sd">        &lt;http://matplotlib.org/api/patches_api.html#matplotlib.patches.Polygon&gt;`_.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``AxesSubplot`` or ``GeoAxesSubplot``</span>
<span class="sd">        The plot axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No &#39;hue&#39; specified.&quot;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">ChoroplethPlot</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span> <span class="n">HueMixin</span><span class="p">,</span> <span class="n">LegendMixin</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_hue_values</span><span class="p">(</span><span class="n">color_kwarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_color</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paint_legend</span><span class="p">(</span><span class="n">supports_hue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">supports_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ax</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">):</span>
                    <span class="n">features</span> <span class="o">=</span> <span class="n">ShapelyFeature</span><span class="p">([</span><span class="n">geom</span><span class="p">],</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>  <span class="c1"># Duck test for MultiPolygon.</span>
                        <span class="k">for</span> <span class="n">subgeom</span> <span class="ow">in</span> <span class="n">geom</span><span class="p">:</span>
                            <span class="n">feature</span> <span class="o">=</span> <span class="n">descartes</span><span class="o">.</span><span class="n">PolygonPatch</span><span class="p">(</span>
                                <span class="n">subgeom</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                            <span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>  <span class="c1"># Shapely Polygon.</span>
                        <span class="n">feature</span> <span class="o">=</span> <span class="n">descartes</span><span class="o">.</span><span class="n">PolygonPatch</span><span class="p">(</span>
                            <span class="n">geom</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                        <span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ax</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="n">ChoroplethPlot</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="n">legend_values</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="n">legend_labels</span><span class="p">,</span>
        <span class="n">legend_kwargs</span><span class="o">=</span><span class="n">legend_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">quadtree</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nsig</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legend_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A choropleth with point aggregate neighborhoods.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : GeoDataFrame</span>
<span class="sd">        The data being plotted.</span>
<span class="sd">    projection : geoplot.crs object instance, optional</span>
<span class="sd">        The projection to use. For reference see</span>
<span class="sd">        `Working with Projections</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Working_with_Projections.html&gt;`_.</span>
<span class="sd">    clip : None or iterable or GeoSeries, optional</span>
<span class="sd">        If specified, quadrangles will be clipped to the boundaries of this geometry.</span>
<span class="sd">    hue : None, Series, GeoSeries, iterable, or str, optional</span>
<span class="sd">        The column in the dataset (or an iterable of some other data) used to color the points.</span>
<span class="sd">        For a reference on this and the other hue-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Hue</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#hue&gt;`_.</span>
<span class="sd">    cmap : matplotlib color, optional</span>
<span class="sd">        If ``hue`` is specified, the</span>
<span class="sd">        `colormap &lt;http://matplotlib.org/examples/color/colormaps_reference.html&gt;`_ to use.</span>
<span class="sd">    norm: function, optional</span>
<span class="sd">        A `colormap normalization function &lt;https://matplotlib.org/users/colormapnorms.html&gt;`_</span>
<span class="sd">        which will be applied to the data before plotting.</span>
<span class="sd">    scheme : None or mapclassify object, optional</span>
<span class="sd">        The categorical binning scheme to use.</span>
<span class="sd">    nmax : int or None, optional</span>
<span class="sd">        The maximum number of observations in a quadrangle.</span>
<span class="sd">    nmin : int, optional</span>
<span class="sd">        The minimum number of observations in a quadrangle.</span>
<span class="sd">    nsig : int, optional</span>
<span class="sd">        The minimum number of observations in a quadrangle. Defaults to 0 (only empty patches are</span>
<span class="sd">        removed).</span>
<span class="sd">    agg : function, optional</span>
<span class="sd">        The aggregation func used for the colormap. Defaults to ``np.mean``.</span>
<span class="sd">    legend : boolean, optional</span>
<span class="sd">        Whether or not to include a map legend. For a reference on this and the other </span>
<span class="sd">        legend-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Legend</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#legend&gt;`_.</span>
<span class="sd">    legend_values : list, optional</span>
<span class="sd">        The data values to be used in the legend.</span>
<span class="sd">    legend_labels : list, optional</span>
<span class="sd">        The data labels to be used in the legend.</span>
<span class="sd">    legend_kwargs : dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying legend.</span>
<span class="sd">    extent : None or (min_longitude, min_latitude, max_longitude, max_latitude), optional</span>
<span class="sd">        Controls the plot extents. For reference see </span>
<span class="sd">        `Customizing Plots#Extent</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#extent&gt;`_.</span>
<span class="sd">    figsize : (x, y) tuple, optional</span>
<span class="sd">        Sets the size of the plot figure (in inches).</span>
<span class="sd">    ax : AxesSubplot or GeoAxesSubplot instance, optional</span>
<span class="sd">        If set, the ``matplotlib.axes.AxesSubplot`` or ``cartopy.mpl.geoaxes.GeoAxesSubplot``</span>
<span class="sd">        instance to paint the plot on. Defaults to a new axis.</span>
<span class="sd">    kwargs: dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying ``matplotlib`` `Polygon patches</span>
<span class="sd">        &lt;http://matplotlib.org/api/patches_api.html#matplotlib.patches.Polygon&gt;`_.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``AxesSubplot`` or ``GeoAxesSubplot``</span>
<span class="sd">        The plot axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">QuadtreePlot</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span> <span class="n">QuadtreeComputeMixin</span><span class="p">,</span> <span class="n">QuadtreeHueMixin</span><span class="p">,</span> <span class="n">LegendMixin</span><span class="p">,</span> <span class="n">ClipMixin</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_quadtree</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_hue_values</span><span class="p">(</span><span class="n">color_kwarg</span><span class="o">=</span><span class="s1">&#39;facecolor&#39;</span><span class="p">,</span> <span class="n">default_color</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paint_legend</span><span class="p">(</span><span class="n">supports_hue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">supports_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ax</span>

            <span class="n">geoms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partitions</span><span class="p">:</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">bounds</span>
                <span class="n">rect</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span>
                    <span class="p">[(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">),</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">)]</span>
                <span class="p">)</span>
                <span class="n">geoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
            <span class="n">geoms</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">geoms</span><span class="p">)</span>
            <span class="n">geoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_clip</span><span class="p">(</span><span class="n">geoms</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">geoms</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">):</span>
                <span class="c1"># Splitting rules that specify an nmax but not an nmin can result in partitions</span>
                <span class="c1"># which are completely outside (e.g. do not intersect at all with) the clip</span>
                <span class="c1"># geometry. The intersection operation run in set_clip will return an empty</span>
                <span class="c1"># GeometryCollection for these results. The plot drivers do not try to interpret</span>
                <span class="c1"># GeometryCollection objects, even empty ones, and will raise an error when passed</span>
                <span class="c1"># one, so we have to exclude these bad partitions ourselves.</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">GeometryCollection</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
                    <span class="n">feature</span> <span class="o">=</span> <span class="n">ShapelyFeature</span><span class="p">([</span><span class="n">geom</span><span class="p">],</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span>
                        <span class="n">feature</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">feature</span> <span class="o">=</span> <span class="n">descartes</span><span class="o">.</span><span class="n">PolygonPatch</span><span class="p">(</span>
                        <span class="n">geom</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                    <span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ax</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="n">QuadtreePlot</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
        <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
        <span class="n">nmax</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span> <span class="n">nmin</span><span class="o">=</span><span class="n">nmin</span><span class="p">,</span> <span class="n">nsig</span><span class="o">=</span><span class="n">nsig</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="n">agg</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="n">legend_values</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="n">legend_labels</span><span class="p">,</span>
        <span class="n">legend_kwargs</span><span class="o">=</span><span class="n">legend_kwargs</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">cartogram</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">scale_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A scaling area plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : GeoDataFrame</span>
<span class="sd">        The data being plotted.</span>
<span class="sd">    projection : geoplot.crs object instance, optional</span>
<span class="sd">        The projection to use. For reference see</span>
<span class="sd">        `Working with Projections</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Working_with_Projections.html&gt;`_.</span>
<span class="sd">    scale : str or iterable, optional</span>
<span class="sd">        The column in the dataset (or an iterable of some other data) with which to scale output</span>
<span class="sd">        points. For a reference on this and the other scale-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Scale </span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#scale&gt;`_.</span>
<span class="sd">    limits : (min, max) tuple, optional</span>
<span class="sd">        If ``scale`` is set, the minimum and maximum size of the points.</span>
<span class="sd">    scale_func : ufunc, optional</span>
<span class="sd">        If ``scale`` is set, the function used to determine the size of each point. For reference</span>
<span class="sd">        see the</span>
<span class="sd">        `Pointplot Scale Functions</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/gallery/plot_usa_city_elevations.html#sphx-glr-gallery-plot-usa-city-elevations-py&gt;`_</span>
<span class="sd">        demo.</span>
<span class="sd">    hue : None, Series, GeoSeries, iterable, or str, optional</span>
<span class="sd">        The column in the dataset (or an iterable of some other data) used to color the points.</span>
<span class="sd">        For a reference on this and the other hue-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Hue</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#hue&gt;`_.</span>
<span class="sd">    cmap : matplotlib color, optional</span>
<span class="sd">        If ``hue`` is specified, the</span>
<span class="sd">        `colormap &lt;http://matplotlib.org/examples/color/colormaps_reference.html&gt;`_ to use.</span>
<span class="sd">    norm: function, optional</span>
<span class="sd">        A `colormap normalization function &lt;https://matplotlib.org/users/colormapnorms.html&gt;`_</span>
<span class="sd">        which will be applied to the data before plotting.</span>
<span class="sd">    scheme : None or mapclassify object, optional</span>
<span class="sd">        If ``hue`` is specified, the categorical binning scheme to use.</span>
<span class="sd">    legend : boolean, optional</span>
<span class="sd">        Whether or not to include a map legend. For a reference on this and the other </span>
<span class="sd">        legend-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Legend</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#legend&gt;`_.</span>
<span class="sd">    legend_values : list, optional</span>
<span class="sd">        The data values to be used in the legend.</span>
<span class="sd">    legend_labels : list, optional</span>
<span class="sd">        The data labels to be used in the legend.</span>
<span class="sd">    legend_var : &quot;hue&quot; or &quot;scale&quot;, optional</span>
<span class="sd">        Which variable, ``hue`` or ``scale``, to use in the legend.</span>
<span class="sd">    legend_kwargs : dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying legend.</span>
<span class="sd">    extent : None or (min_longitude, min_latitude, max_longitude, max_latitude), optional</span>
<span class="sd">        Controls the plot extents. For reference see </span>
<span class="sd">        `Customizing Plots#Extent</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#extent&gt;`_.</span>
<span class="sd">    figsize : (x, y) tuple, optional</span>
<span class="sd">        Sets the size of the plot figure (in inches).</span>
<span class="sd">    ax : AxesSubplot or GeoAxesSubplot instance, optional</span>
<span class="sd">        If set, the ``matplotlib.axes.AxesSubplot`` or ``cartopy.mpl.geoaxes.GeoAxesSubplot``</span>
<span class="sd">        instance to paint the plot on. Defaults to a new axis.</span>
<span class="sd">    kwargs: dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying ``matplotlib`` `Polygon patches</span>
<span class="sd">        &lt;http://matplotlib.org/api/patches_api.html#matplotlib.patches.Polygon&gt;`_.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``AxesSubplot`` or ``GeoAxesSubplot``</span>
<span class="sd">        The plot axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No scale parameter provided.&quot;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">CartogramPlot</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span> <span class="n">HueMixin</span><span class="p">,</span> <span class="n">ScaleMixin</span><span class="p">,</span> <span class="n">LegendMixin</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_scale_values</span><span class="p">(</span><span class="n">size_kwarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_hue_values</span><span class="p">(</span><span class="n">color_kwarg</span><span class="o">=</span><span class="s1">&#39;facecolor&#39;</span><span class="p">,</span> <span class="n">default_color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>

            <span class="c1"># Scaling a legend marker means scaling a point, whereas scaling a cartogram</span>
            <span class="c1"># marker means scaling a polygon. The same scale has radically different effects</span>
            <span class="c1"># on these two in perceptive terms. The scale_multiplier helps to make the point</span>
            <span class="c1"># scaling commutative to the polygon scaling, though it&#39;s really just a guess.</span>
            <span class="c1"># 25 is chosen because it is 5**2, where 5 is a &quot;good&quot; value for the radius of a</span>
            <span class="c1"># point in a scatter point.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paint_legend</span><span class="p">(</span>
                <span class="n">supports_hue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">supports_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale_multiplier</span><span class="o">=</span><span class="mi">25</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ax</span>

            <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">polygon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">):</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">scaled_polygon</span> <span class="o">=</span> <span class="n">shapely</span><span class="o">.</span><span class="n">affinity</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span>
                    <span class="n">polygon</span><span class="p">,</span> <span class="n">xfact</span><span class="o">=</span><span class="n">scale_factor</span><span class="p">,</span> <span class="n">yfact</span><span class="o">=</span><span class="n">scale_factor</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">features</span> <span class="o">=</span> <span class="n">ShapelyFeature</span><span class="p">([</span><span class="n">scaled_polygon</span><span class="p">],</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>  <span class="c1"># Duck test for MultiPolygon.</span>
                        <span class="k">for</span> <span class="n">subgeom</span> <span class="ow">in</span> <span class="n">scaled_polygon</span><span class="p">:</span>
                            <span class="n">feature</span> <span class="o">=</span> <span class="n">descartes</span><span class="o">.</span><span class="n">PolygonPatch</span><span class="p">(</span>
                                <span class="n">subgeom</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                            <span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>  <span class="c1"># Shapely Polygon.</span>
                        <span class="n">feature</span> <span class="o">=</span> <span class="n">descartes</span><span class="o">.</span><span class="n">PolygonPatch</span><span class="p">(</span>
                            <span class="n">scaled_polygon</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                        <span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ax</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="n">CartogramPlot</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">scale_func</span><span class="o">=</span><span class="n">scale_func</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="n">legend_values</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="n">legend_labels</span><span class="p">,</span>
        <span class="n">legend_kwargs</span><span class="o">=</span><span class="n">legend_kwargs</span><span class="p">,</span> <span class="n">legend_var</span><span class="o">=</span><span class="n">legend_var</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">kdeplot</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shade_lowest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A kernel density estimate isochrone plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : GeoDataFrame</span>
<span class="sd">        The data being plotted.</span>
<span class="sd">    projection : geoplot.crs object instance, optional</span>
<span class="sd">        The projection to use. For reference see</span>
<span class="sd">        `Working with Projections</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Working_with_Projections.html&gt;`_.</span>
<span class="sd">    cmap : matplotlib color, optional</span>
<span class="sd">        The `colormap &lt;http://matplotlib.org/examples/color/colormaps_reference.html&gt;`_ to use.</span>
<span class="sd">    clip : None or iterable or GeoSeries, optional</span>
<span class="sd">        If specified, isochrones will be clipped to the boundaries of this geometry.</span>
<span class="sd">    extent : None or (min_longitude, min_latitude, max_longitude, max_latitude), optional</span>
<span class="sd">        Controls the plot extents. For reference see </span>
<span class="sd">        `Customizing Plots#Extent</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#extent&gt;`_.</span>
<span class="sd">    figsize : (x, y) tuple, optional</span>
<span class="sd">        Sets the size of the plot figure (in inches).</span>
<span class="sd">    ax : AxesSubplot or GeoAxesSubplot instance, optional</span>
<span class="sd">        If set, the ``matplotlib.axes.AxesSubplot`` or ``cartopy.mpl.geoaxes.GeoAxesSubplot``</span>
<span class="sd">        instance to paint the plot on. Defaults to a new axis.</span>
<span class="sd">    kwargs: dict, optional</span>
<span class="sd">        Keyword arguments to be passed to </span>
<span class="sd">        `the underlying seaborn.kdeplot instance &lt;http://seaborn.pydata.org/generated/seaborn.kdeplot.html#seaborn.kdeplot&gt;`_.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``AxesSubplot`` or ``GeoAxesSubplot``</span>
<span class="sd">        The plot axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>  <span class="c1"># Immediately fail if no seaborn.</span>

    <span class="k">class</span> <span class="nc">KDEPlot</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span> <span class="n">HueMixin</span><span class="p">,</span> <span class="n">LegendMixin</span><span class="p">,</span> <span class="n">ClipMixin</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_hue_values</span><span class="p">(</span>
                <span class="n">color_kwarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">supports_categorical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">verify_input</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paint_legend</span><span class="p">(</span><span class="n">supports_hue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">supports_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verify_input</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paint_clip</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">shade_lowest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;shade_lowest&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ax</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">]),</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">]),</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">shade_lowest</span><span class="o">=</span><span class="n">shade_lowest</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">]),</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">]),</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">shade_lowest</span><span class="o">=</span><span class="n">shade_lowest</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="n">KDEPlot</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span>
        <span class="n">shade_lowest</span><span class="o">=</span><span class="n">shade_lowest</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">sankey</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legend_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A spatial Sankey or flow map.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : GeoDataFrame, optional</span>
<span class="sd">        The data being plotted.</span>
<span class="sd">    projection : geoplot.crs object instance, optional</span>
<span class="sd">        The projection to use. For reference see</span>
<span class="sd">        `Working with Projections</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Working_with_Projections.html&gt;`_.</span>
<span class="sd">    hue : None, Series, GeoSeries, iterable, or str, optional</span>
<span class="sd">        The column in the dataset (or an iterable of some other data) used to color the points.</span>
<span class="sd">        For a reference on this and the other hue-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Hue</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#hue&gt;`_.</span>
<span class="sd">    cmap : matplotlib color, optional</span>
<span class="sd">        If ``hue`` is specified, the</span>
<span class="sd">        `colormap &lt;http://matplotlib.org/examples/color/colormaps_reference.html&gt;`_ to use.</span>
<span class="sd">    norm: function, optional</span>
<span class="sd">        A `colormap normalization function &lt;https://matplotlib.org/users/colormapnorms.html&gt;`_</span>
<span class="sd">        which will be applied to the data before plotting.</span>
<span class="sd">    scheme : None or mapclassify object, optional</span>
<span class="sd">        If ``hue`` is specified, the categorical binning scheme to use.</span>
<span class="sd">    scale : str or iterable, optional</span>
<span class="sd">        The column in the dataset (or an iterable of some other data) with which to scale output</span>
<span class="sd">        points. For a reference on this and the other scale-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Scale </span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#scale&gt;`_.</span>
<span class="sd">    limits : (min, max) tuple, optional</span>
<span class="sd">        If ``scale`` is set, the minimum and maximum size of the points.</span>
<span class="sd">    scale_func : ufunc, optional</span>
<span class="sd">        If ``scale`` is set, the function used to determine the size of each point. For reference</span>
<span class="sd">        see the</span>
<span class="sd">        `Pointplot Scale Functions</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/gallery/plot_usa_city_elevations.html#sphx-glr-gallery-plot-usa-city-elevations-py&gt;`_</span>
<span class="sd">        demo.</span>
<span class="sd">    legend : boolean, optional</span>
<span class="sd">        Whether or not to include a map legend. For a reference on this and the other </span>
<span class="sd">        legend-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Legend</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#legend&gt;`_.</span>
<span class="sd">    legend_values : list, optional</span>
<span class="sd">        The data values to be used in the legend.</span>
<span class="sd">    legend_labels : list, optional</span>
<span class="sd">        The data labels to be used in the legend.</span>
<span class="sd">    legend_var : &quot;hue&quot; or &quot;scale&quot;, optional</span>
<span class="sd">        Which variable, ``hue`` or ``scale``, to use in the legend.</span>
<span class="sd">    legend_kwargs : dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying legend.</span>
<span class="sd">    extent : None or (min_longitude, min_latitude, max_longitude, max_latitude), optional</span>
<span class="sd">        Controls the plot extents. For reference see </span>
<span class="sd">        `Customizing Plots#Extent</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#extent&gt;`_.</span>
<span class="sd">    figsize : (x, y) tuple, optional</span>
<span class="sd">        Sets the size of the plot figure (in inches).</span>
<span class="sd">    ax : AxesSubplot or GeoAxesSubplot instance, optional</span>
<span class="sd">        If set, the ``matplotlib.axes.AxesSubplot`` or ``cartopy.mpl.geoaxes.GeoAxesSubplot``</span>
<span class="sd">        instance to paint the plot on. Defaults to a new axis.</span>
<span class="sd">    kwargs: dict, optional</span>
<span class="sd">        Keyword arguments to be passed to </span>
<span class="sd">        `the underlying matplotlib.lines.Line2D &lt;https://matplotlib.org/api/_as_gen/matplotlib.lines.Line2D.html#matplotlib.lines.Line2D&gt;`_</span>
<span class="sd">        instances.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``AxesSubplot`` or ``GeoAxesSubplot``</span>
<span class="sd">        The plot axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">SankeyPlot</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span> <span class="n">HueMixin</span><span class="p">,</span> <span class="n">ScaleMixin</span><span class="p">,</span> <span class="n">LegendMixin</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Most markers use &#39;color&#39; or &#39;facecolor&#39; as their color_kwarg, and this parameter</span>
            <span class="c1"># has the same name as a matplotlib feature (for unprojected plots) and as a decartes</span>
            <span class="c1"># feature (for projected plots). With line markers, things are different. The</span>
            <span class="c1"># matplotlib Line2D marker uses &#39;color&#39; (it also has an &#39;markeredgecolor&#39;, but this</span>
            <span class="c1"># parameter doesn&#39;t perform exactly like the &#39;edgecolor&#39; elsewhere in the API). The</span>
            <span class="c1"># descartes feature uses &#39;edgecolor&#39;.</span>
            <span class="c1"># </span>
            <span class="c1"># This complicates keywords in the Sankey API (the only plot type so far that uses a</span>
            <span class="c1"># line marker). For code cleanliness, we choose to support &quot;color&quot; and not</span>
            <span class="c1"># &quot;edgecolor&quot;, and to raise if an &quot;edgecolor&quot; is set.</span>
            <span class="k">if</span> <span class="s1">&#39;edgecolor&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Invalid parameter &quot;edgecolor&quot;. To control line color, use &quot;color&quot;.&#39;</span>
                <span class="p">)</span>

            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_hue_values</span><span class="p">(</span><span class="n">color_kwarg</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">default_color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_scale_values</span><span class="p">(</span><span class="n">size_kwarg</span><span class="o">=</span><span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="n">default_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paint_legend</span><span class="p">(</span><span class="n">supports_hue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">supports_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ax</span>

            <span class="k">def</span> <span class="nf">parse_geom</span><span class="p">(</span><span class="n">geom</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">LineString</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">geom</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiLineString</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">geom</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">MultiPoint</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">shapely</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">LineString</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;df.geometry must contain LineString, MultiLineString, or MultiPoint &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;geometries, but an instance of </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="si">}</span><span class="s1"> was found instead.&#39;</span>
                    <span class="p">)</span>
            <span class="n">path_geoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_geom</span><span class="p">)</span>

            <span class="n">linestyle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;linestyle&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">linestyle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">width</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">path_geoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">):</span>
                    <span class="n">feature</span> <span class="o">=</span> <span class="n">ShapelyFeature</span><span class="p">([</span><span class="n">line</span><span class="p">],</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span>
                        <span class="n">feature</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">width</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">path_geoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizes</span><span class="p">):</span>
                    <span class="c1"># We have to implement different methods for dealing with LineString and</span>
                    <span class="c1"># MultiLineString objects.</span>
                    <span class="k">try</span><span class="p">:</span>  <span class="c1"># LineString</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">coords</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">coords</span><span class="p">],</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                        <span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>  <span class="c1"># MultiLineString</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">coords</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">coords</span><span class="p">],</span>
                                <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                            <span class="p">)</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="n">SankeyPlot</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="n">scale_func</span><span class="o">=</span><span class="n">scale_func</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="n">legend_values</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="n">legend_labels</span><span class="p">,</span>
        <span class="n">legend_kwargs</span><span class="o">=</span><span class="n">legend_kwargs</span><span class="p">,</span> <span class="n">legend_var</span><span class="o">=</span><span class="n">legend_var</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">voronoi</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legend_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A geospatial Voronoi diagram.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : GeoDataFrame</span>
<span class="sd">        The data being plotted.</span>
<span class="sd">    projection : geoplot.crs object instance, optional</span>
<span class="sd">        The projection to use. For reference see</span>
<span class="sd">        `Working with Projections</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Working_with_Projections.html&gt;`_.</span>
<span class="sd">    clip : None or iterable or GeoSeries, optional</span>
<span class="sd">        If specified, the output will be clipped to the boundaries of this geometry.</span>
<span class="sd">    hue : None, Series, GeoSeries, iterable, or str, optional</span>
<span class="sd">        The column in the dataset (or an iterable of some other data) used to color the points.</span>
<span class="sd">        For a reference on this and the other hue-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Hue</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#hue&gt;`_.</span>
<span class="sd">    cmap : matplotlib color, optional</span>
<span class="sd">        If ``hue`` is specified, the</span>
<span class="sd">        `colormap &lt;http://matplotlib.org/examples/color/colormaps_reference.html&gt;`_ to use.</span>
<span class="sd">    norm: function, optional</span>
<span class="sd">        A `colormap normalization function &lt;https://matplotlib.org/users/colormapnorms.html&gt;`_</span>
<span class="sd">        which will be applied to the data before plotting.</span>
<span class="sd">    scheme : None or mapclassify object, optional</span>
<span class="sd">        If ``hue`` is specified, the categorical binning scheme to use.</span>
<span class="sd">    scale : str or iterable, optional</span>
<span class="sd">        The column in the dataset (or an iterable of some other data) with which to scale output</span>
<span class="sd">        points. For a reference on this and the other scale-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Scale </span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#scale&gt;`_.</span>
<span class="sd">    limits : (min, max) tuple, optional</span>
<span class="sd">        If ``scale`` is set, the minimum and maximum size of the points.</span>
<span class="sd">    scale_func : ufunc, optional</span>
<span class="sd">        If ``scale`` is set, the function used to determine the size of each point. For reference</span>
<span class="sd">        see the</span>
<span class="sd">        `Pointplot Scale Functions</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/gallery/plot_usa_city_elevations.html#sphx-glr-gallery-plot-usa-city-elevations-py&gt;`_</span>
<span class="sd">        demo.</span>
<span class="sd">    legend : boolean, optional</span>
<span class="sd">        Whether or not to include a map legend. For a reference on this and the other </span>
<span class="sd">        legend-related parameters that follow, see</span>
<span class="sd">        `Customizing Plots#Legend</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#legend&gt;`_.</span>
<span class="sd">    legend_values : list, optional</span>
<span class="sd">        The data values to be used in the legend.</span>
<span class="sd">    legend_labels : list, optional</span>
<span class="sd">        The data labels to be used in the legend.</span>
<span class="sd">    legend_var : &quot;hue&quot; or &quot;scale&quot;, optional</span>
<span class="sd">        Which variable, ``hue`` or ``scale``, to use in the legend.</span>
<span class="sd">    legend_kwargs : dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying legend.</span>
<span class="sd">    extent : None or (min_longitude, min_latitude, max_longitude, max_latitude), optional</span>
<span class="sd">        Controls the plot extents. For reference see </span>
<span class="sd">        `Customizing Plots#Extent</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#extent&gt;`_.</span>
<span class="sd">    figsize : (x, y) tuple, optional</span>
<span class="sd">        Sets the size of the plot figure (in inches).</span>
<span class="sd">    ax : AxesSubplot or GeoAxesSubplot instance, optional</span>
<span class="sd">        If set, the ``matplotlib.axes.AxesSubplot`` or ``cartopy.mpl.geoaxes.GeoAxesSubplot``</span>
<span class="sd">        instance to paint the plot on. Defaults to a new axis.</span>
<span class="sd">    kwargs: dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying ``matplotlib`` `Line2D objects</span>
<span class="sd">        &lt;http://matplotlib.org/api/lines_api.html#matplotlib.lines.Line2D&gt;`_.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``AxesSubplot`` or ``GeoAxesSubplot``</span>
<span class="sd">        The plot axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">VoronoiPlot</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span> <span class="n">HueMixin</span><span class="p">,</span> <span class="n">LegendMixin</span><span class="p">,</span> <span class="n">ClipMixin</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_hue_values</span><span class="p">(</span><span class="n">color_kwarg</span><span class="o">=</span><span class="s1">&#39;facecolor&#39;</span><span class="p">,</span> <span class="n">default_color</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paint_legend</span><span class="p">(</span><span class="n">supports_hue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">supports_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ax</span>

            <span class="n">geoms</span> <span class="o">=</span> <span class="n">build_voronoi_polygons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
            <span class="c1"># Must take the .values of the output GeoDataFrame because assign is index-aligned.</span>
            <span class="c1"># So self.df can have any index. But set_clip constructs a new GeoSeries with a fresh</span>
            <span class="c1"># descending (1..N) index. If self.df doesn&#39;t also have a 1..N index, the join will</span>
            <span class="c1"># be misaligned and/or nan values will be inserted. The easiest way to assign in an</span>
            <span class="c1"># index-naive (e.g. index-based) manner is to provide a numpy array instead of a</span>
            <span class="c1"># GeoSeries by taking .values.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">set_clip</span><span class="p">(</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">geoms</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">geom</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>  <span class="c1"># do not plot data points that return empty due to clipping</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">:</span>
                    <span class="n">feature</span> <span class="o">=</span> <span class="n">ShapelyFeature</span><span class="p">([</span><span class="n">geom</span><span class="p">],</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span>
                        <span class="n">feature</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">feature</span> <span class="o">=</span> <span class="n">descartes</span><span class="o">.</span><span class="n">PolygonPatch</span><span class="p">(</span>
                        <span class="n">geom</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                    <span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ax</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="n">VoronoiPlot</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">legend_values</span><span class="o">=</span><span class="n">legend_values</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="n">legend_labels</span><span class="p">,</span>
        <span class="n">legend_kwargs</span><span class="o">=</span><span class="n">legend_kwargs</span><span class="p">,</span>
        <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">plot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">webmap</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">provider</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">OpenStreetMap</span><span class="o">.</span><span class="n">Mapnik</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A webmap.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : GeoDataFrame</span>
<span class="sd">        The data being plotted.</span>
<span class="sd">    projection : geoplot.crs object instance, optional</span>
<span class="sd">        The projection to use. For reference see</span>
<span class="sd">        `Working with Projections</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Working_with_Projections.html&gt;`_.</span>
<span class="sd">        ``webmap`` only supports a single projection: ``WebMercator``.</span>
<span class="sd">    extent : None or (min_longitude, min_latitude, max_longitude, max_latitude), optional</span>
<span class="sd">        Controls the plot extents. For reference see </span>
<span class="sd">        `Customizing Plots#Extent</span>
<span class="sd">        &lt;https://residentmario.github.io/geoplot/user_guide/Customizing_Plots.html#extent&gt;`_.</span>
<span class="sd">    zoom: None or int</span>
<span class="sd">        The zoom level to use when fetching webmap tiles. Higher zoom levels mean more detail,</span>
<span class="sd">        but will also take longer to generate and will have more clutter. There are generally</span>
<span class="sd">        only two or three zoom levels that are appropriate for any given area. For reference</span>
<span class="sd">        see the OpenStreetMaps reference on </span>
<span class="sd">        `zoom levels &lt;https://wiki.openstreetmap.org/wiki/Zoom_levels&gt;`_.</span>
<span class="sd">    provider: contextily.providers object</span>
<span class="sd">        The tile provider. If no provider is set, the default OpenStreetMap tile service,</span>
<span class="sd">        contextily.providers.OpenStreetMap.Mapnik, will be used. For reference see `the contextily</span>
<span class="sd">        documentation &lt;https://github.com/darribas/contextily&gt;`_.</span>
<span class="sd">    figsize : (x, y) tuple, optional</span>
<span class="sd">        Sets the size of the plot figure (in inches).</span>
<span class="sd">    ax : AxesSubplot or GeoAxesSubplot instance, optional</span>
<span class="sd">        If set, the ``matplotlib.axes.AxesSubplot`` or ``cartopy.mpl.geoaxes.GeoAxesSubplot``</span>
<span class="sd">        instance to paint the plot on. Defaults to a new axis.</span>
<span class="sd">    kwargs: dict, optional</span>
<span class="sd">        Keyword arguments to be passed to the underlying matplotlib `Polygon patches</span>
<span class="sd">        &lt;http://matplotlib.org/api/patches_api.html#matplotlib.patches.Polygon&gt;`_.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ``AxesSubplot`` or ``GeoAxesSubplot``</span>
<span class="sd">        The plot axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">WebmapPlot</span><span class="p">(</span><span class="n">Plot</span><span class="p">):</span>
        <span class="c1"># webmap is restricted to the WebMercator projection, which requires special axis and</span>
        <span class="c1"># projection initialization rules to get right.</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">GeoAxesSubplot</span><span class="p">):</span>
                <span class="n">proj_name</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">if</span> <span class="n">proj_name</span> <span class="o">!=</span> <span class="s1">&#39;WebMercator&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;webmap&quot; is only compatible with the &quot;WebMercator&quot; projection, but &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;the input axis is in the </span><span class="si">{</span><span class="n">proj_name</span><span class="si">!r}</span><span class="s1"> projection instead. To fix, &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;pass &quot;projection=gcrs.WebMercator()&quot; to the axis initializer.&#39;</span>
                    <span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&quot;webmap&quot; is only compatible with the &quot;WebMercator&quot; projection, but &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;the input axis is unprojected. To fix, pass &quot;projection=gcrs.WebMercator()&quot; &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;to the axis initializer.&#39;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">projection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&quot;webmap&quot; is only compatible with the &quot;WebMercator&quot; projection, but the &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;input projection is unspecified. Reprojecting the data to &quot;WebMercator&quot; &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;automatically. To suppress this warning, set &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;&quot;projection=gcrs.WebMercator()&quot; explicitly.&#39;</span>
                <span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">gcrs</span><span class="o">.</span><span class="n">WebMercator</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                  <span class="n">projection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                  <span class="n">projection</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;WebMercator&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&quot;webmap&quot; is only compatible with the &quot;WebMercator&quot; projection, but &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;the input projection is set to </span><span class="si">{</span><span class="n">projection</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s1">. Set &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;projection=gcrs.WebMercator() instead.&#39;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                  <span class="n">projection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                  <span class="n">projection</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;WebMercator&#39;</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">zoom</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;zoom&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># The plot extent is a well-defined function of plot data geometry and user input to</span>
            <span class="c1"># the &quot;extent&quot; parameter, except in the case of numerical instability or invalid user</span>
            <span class="c1"># input, in which case the default plot extent for the given projection is used. But</span>
            <span class="c1"># the default extent is not well-exposed inside of the Cartopy API, so in edge cases</span>
            <span class="c1"># where we are forced to fall back to default extent we don&#39;t actually know the true</span>
            <span class="c1"># plot extent.</span>
            <span class="c1">#</span>
            <span class="c1"># For this reason we (1) recalculate &quot;good case&quot; plot extent here, instead of saving</span>
            <span class="c1"># the value to an init variable and (2) accept that this calculation is potentially</span>
            <span class="c1"># incorrect in edge cases.</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="n">relax_bounds</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span>

            <span class="k">if</span> <span class="n">zoom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">zoom</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">_calculate_zoom</span><span class="p">(</span><span class="o">*</span><span class="n">extent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">howmany</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">howmany</span><span class="p">(</span><span class="o">*</span><span class="n">extent</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">ll</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">howmany</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">better_zoom_level</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">tile</span><span class="o">.</span><span class="n">_calculate_zoom</span><span class="p">(</span><span class="o">*</span><span class="n">extent</span><span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Generating a webmap at zoom level </span><span class="si">{</span><span class="n">zoom</span><span class="si">}</span><span class="s1"> for the given plot extent &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;requires downloading </span><span class="si">{</span><span class="n">howmany</span><span class="si">}</span><span class="s1"> individual tiles. This slows down &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;plot generation and places additional pressure on the tile &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;provider</span><span class="se">\&#39;</span><span class="s1">s server, which many deny your request when placed under &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;high load or high request volume. Consider setting &quot;zoom&quot; to &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">better_zoom_level</span><span class="si">}</span><span class="s1"> instead. This is the recommended zoom level for &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;the given plot extent.&#39;</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">zoom</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_webmap_extent</span> <span class="o">=</span> <span class="n">extent</span>

        <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">ax</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ax</span>

            <span class="n">basemap</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">bounds2img</span><span class="p">(</span>
                <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_webmap_extent</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span> 
                <span class="n">source</span><span class="o">=</span><span class="n">provider</span><span class="p">,</span> <span class="n">ll</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">basemap</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>

    <span class="n">plot</span> <span class="o">=</span> <span class="n">WebmapPlot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plot</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="c1">##################</span>
<span class="c1"># HELPER METHODS #</span>
<span class="c1">##################</span>

<span class="k">def</span> <span class="nf">_to_geom_geoseries</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">geometry</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_to_geoseries</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">_to_geoseries</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Some top-level parameters present in most plot types accept a variety of iterables as input</span>
<span class="sd">    types. This method condenses this variety into a single preferred format - a GeoSeries whose</span>
<span class="sd">    index aligns with that of the master GeoDataFrame.</span>

<span class="sd">    Input to geometry variables perform a bit differently from input to non-geometry variables:</span>
<span class="sd">    GeoDataFrame values is and index validation doesn&#39;t need to performed. Cf. _to_geom_geoseries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Data taken from the input GeoDataFrame do not need index validation.</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">var</span>

    <span class="c1"># GeoSeries and dict inputs need validation to make sure the index matches.</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">var</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="c1"># List-like inputs do not need index validation, it simply takes on the base data index.</span>
    <span class="c1"># However, it has to be the exact same length as the base data.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="si">}</span><span class="s2"> values were passed to </span><span class="si">{</span><span class="n">var_name</span><span class="si">!r}</span><span class="s2">, but </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> were expected.&quot;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">!r}</span><span class="s2"> expects a GeoSeries, str, or list-like object as input, but a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="si">}</span><span class="s2"> was provided instead.&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
        <span class="c1"># df is allowed to have duplicates in its index, but the input series is not the input series</span>
        <span class="c1"># index must be a superset of the df index</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The input provided to </span><span class="si">{</span><span class="n">var_name</span><span class="si">!r}</span><span class="s2"> contains duplicate values in its index, which &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is not allowed. Try using pandas.Series.drop_duplicates or &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;pandas.DataFrame.drop_duplicates to remove the extra values.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">var_name</span><span class="si">!r}</span><span class="s2"> index is not aligned with the index of the input GeoDataFrame, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;containing only a subset of the expected values. To align your data using index &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;position, try passing your </span><span class="si">{</span><span class="n">var_name</span><span class="si">!r}</span><span class="s2"> data as a list or numpy array instead.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># If we pass validation, shuffle the s index to match the df index before returning</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">_validate_buckets</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hue</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">scheme</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This helper method infers if the ``hue`` parameter is categorical, and sets scheme if isn&#39;t</span>
<span class="sd">    already set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">hue</span><span class="p">]</span>
    <span class="n">count_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">hue</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">hue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">categorical</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># if the data is non-categorical, but there are fewer to equal numbers of bins and</span>
    <span class="c1"># observations, treat it as categorical, as doing so will make the legend cleaner</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue</span><span class="p">)</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">categorical</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hue</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;There are just </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hue</span><span class="p">)</span><span class="si">}</span><span class="s1"> observations in the &quot;hue&quot; data, but &quot;k&quot; is set to </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">. &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;k&quot; will be set to the number of categories of observations in the dataset.&#39;</span>
        <span class="p">)</span>
        <span class="n">categorical</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">count_unique</span> <span class="o">&gt;</span> <span class="n">k</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hue</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)):</span>
        <span class="n">categorical</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">count_unique</span> <span class="o">&gt;</span> <span class="n">k</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hue</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;k&quot; is set to </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">, but &quot;hue&quot; is a column of data of type &quot;object&quot;, which cannot be &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;bucketized discretely. Try setting &quot;k&quot; to None instead.&#39;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">categorical</span> <span class="o">=</span> <span class="p">(</span><span class="n">hue</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">))</span>
    <span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span> <span class="k">if</span> <span class="n">scheme</span> <span class="k">else</span> <span class="s1">&#39;Quantiles&#39;</span>
    <span class="k">return</span> <span class="n">categorical</span><span class="p">,</span> <span class="n">scheme</span>

<span class="k">def</span> <span class="nf">relax_bounds</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Increases the viewport slightly. Used to ameliorate plot featurs that fall out of bounds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">window_resize_val_x</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>
    <span class="n">window_resize_val_y</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span>
    <span class="n">extrema</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="n">xmin</span> <span class="o">-</span> <span class="n">window_resize_val_x</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">-</span> <span class="n">window_resize_val_y</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">180</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">window_resize_val_x</span><span class="p">]),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">90</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">window_resize_val_y</span><span class="p">])</span>
    <span class="p">])</span>
    <span class="k">return</span> <span class="n">extrema</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2020, Aleksey Bilogur

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>